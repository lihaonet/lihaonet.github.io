<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Bugtrap - 简单、自由、随性！</title><meta name="author" content="Bugtrap"><meta name="copyright" content="Bugtrap"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="欢迎访问我的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Bugtrap">
<meta property="og:url" content="https://lihaonet.github.io/page/2/index.html">
<meta property="og:site_name" content="Bugtrap">
<meta property="og:description" content="欢迎访问我的博客">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://q1.qlogo.cn/g?b=qq&nk=47381770&s=140">
<meta property="article:author" content="Bugtrap">
<meta property="article:tag" content="blog,hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://q1.qlogo.cn/g?b=qq&nk=47381770&s=140"><link rel="shortcut icon" href="https://q1.qlogo.cn/g?b=qq&nk=47381770&s=100"><link rel="canonical" href="https://lihaonet.github.io/page/2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Bugtrap',
  isPost: false,
  isHome: true,
  isHighlightShrink: true,
  isToc: false,
  postUpdate: '2024-01-31 12:16:38'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/style.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.0.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=47381770&amp;s=140" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 常用</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page fixed" id="page-header" style="background: transparent"><nav id="nav"><span id="blog-info"><a href="/" title="Bugtrap"><span class="site-name">Bugtrap</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 常用</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Bugtrap</h1><div id="site-subtitle"><span id="subtitle"></span></div><div id="site_social_icons"><a class="social-icon" href="https://lihaonet.github.io" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:47381770@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="http://bugtrap.ysepan.com" target="_blank" title="永硕E盘"><i class="fa-sharp fa-solid fa-hard-drive" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/./img/wx.jpg" target="_blank" title="微信"><i class="fa-brands fa-weixin" style="color: #4a7dbe;"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left"><a href="/648216a0.html" title="11. Raft PartB 选举日志比较"><img class="post-bg" src="https://picsum.photos/1276/400?random=111" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="11. Raft PartB 选举日志比较"></a></div><div class="recent-post-info"><a class="article-title" href="/648216a0.html" title="11. Raft PartB 选举日志比较">11. Raft PartB 选举日志比较</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">在有了日志之后，在进行投票时，就需要进行日志比较了。
因为 Raft 算法是强 Leader 算法，因此会要求 Leader 一定要包含所有已经提交日志。因此，在进行选举时，我们确保只有具有比大多数 Peer 更新日志的候选人才能当选 Leader。
日志新旧比较
关于两个 Peer 所存日志谁更 up-to-date 的问题，论文中是这样描述的：

Raft determines which of two logs is more up-to-date by comparing the index and term of the last entries in the logs.

If the logs have last entries with different terms, then the log with the later term is more up-to-date.
If the logs end with the same term, then whichever log is longer is more up-to-date


总结下，比较对象是最后一个 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/84780d3f.html" title="12. Raft PartB 日志应用"><img class="post-bg" src="https://picsum.photos/1276/400?random=112" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="12. Raft PartB 日志应用"></a></div><div class="recent-post-info"><a class="article-title" href="/84780d3f.html" title="12. Raft PartB 日志应用">12. Raft PartB 日志应用</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">本章我们要增加在代码组织(02.Raft 代码总览)一章中提到的三个工作流中的最后一个：日志应用工作流， applyTicker。
由于 Apply 只有在 commitIndex 变大的时候才会触发，因此我们可以使用 golang 中的条件变量 sync.Cond ，使用唤醒机制，只有在 commitIndex 增大后才唤醒 applyTicker。
字段补全
根据论文图 2 我们需要给 apply 逻辑补上两个字段：

commitIndex：全局日志提交进度
lastApplied：本 Peer 日志 apply 进度

由于我们想在实现时，使用 sync.Cond 唤醒 apply 的工作流，因此需要增加：applyCond。
最后，在我们 Raft 实现的设定中，apply 的过程，就是将 applyMsg 通过构造 Peer 时传进来的 channel 返回给应用层。因此还需要保存下这个 applyCh。
123456789101112// A Go object implementing a single Raft peer.type Raft struct &#123; ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/ca0a1990.html" title="15. Raft PartC 实现和优化"><img class="post-bg" src="https://picsum.photos/1276/400?random=115" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="15. Raft PartC 实现和优化"></a></div><div class="recent-post-info"><a class="article-title" href="/ca0a1990.html" title="15. Raft PartC 实现和优化">15. Raft PartC 实现和优化</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">PartC 最主要的逻辑包括两部分：

实现 Raft 的序列化和反序列化函数
将上述函数插入到代码流程中合适位置

但由于测试时加入了不同 Peer 的宕机重启，对我们之前的选主逻辑和复制逻辑的正确性和性能又提出了更高的要求。也就是说，同样的代码，即使能过 PartB 的测试，也不一定能过 PartC 的测试。
因此，我们本节的大部分时间，反而会花在于对之前代码逻辑的性能提升和查漏补缺上。
逻辑实现
序列化和反序列化
为了使代码模块清晰，我们将这部分也单独拆出一个文件，起名为 raft_persistence.go，主要包括对关键字段的序列化和反序列化两个函数：
123456789101112131415161718192021222324252627282930313233343536373839404142func (rf *Raft) persistLocked() &#123;        w := new(bytes.Buffer)        e := labgob.NewEncoder(w)        e.Encode(rf.currentTerm)       ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2924ee3f.html" title="14. Raft PartC 状态持久化"><img class="post-bg" src="https://picsum.photos/1276/400?random=114" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="14. Raft PartC 状态持久化"></a></div><div class="recent-post-info"><a class="article-title" href="/2924ee3f.html" title="14. Raft PartC 状态持久化">14. Raft PartC 状态持久化</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">实现要求
PartA 和 PartB 基本实现了不宕机情况下的领导者选举、日志同步和日志应用逻辑。但是在当某个 Peer 异常重启后，是不能正常重新加入集群的。为此，需要将 Raft 的关键信息定时持久化，重启后加载，以保证正常加入集群。
至于哪些状态需要持久化，论文图 2 都有标记。这些需要持久化的属性集中任何一个属性发生变化，都需要进行持久化，因为 Peer 任意时刻都有可能宕机。在本课程中，我们不会真将状态持久化到硬盘上，而是使用测试框架中的 persistor.go 中的 Persister 类对数据进行“持久化”，主要涉及两个接口：
12func (ps *Persister) ReadRaftState() []byte &#123;&#125;func (ps *Persister) Save(raftstate []byte, snapshot []byte) &#123;&#125;
ReadRaftState 是反序列化接口，可以认为是从磁盘上读出一个字节数组；Save 是序列化接口，负责将字节数组形式的快照（PartD 才用）和 raft 状态写入磁盘。
写完后在 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/c2b809ab.html" title="13. Raft PartB 调试和小结"><img class="post-bg" src="https://picsum.photos/1276/400?random=113" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="13. Raft PartB 调试和小结"></a></div><div class="recent-post-info"><a class="article-title" href="/c2b809ab.html" title="13. Raft PartB 调试和小结">13. Raft PartB 调试和小结</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">经过调试，我们有几个地方没有实现对：日志同步的 reply 处理前没有检查 context、Start 没有实现、AppendEntries 日志判断。
Context 检查
需要 Context 检查的主要有四个地方：

startReplication 前，检查自己仍然是给定 term 的 Leader
replicateToPeer 处理 reply 时，检查自己仍然是给定 term 的 Leader
startElection 前，检查自己仍然是给定 term 的 Candidate
askVoteFromPeer 处理 reply 时，检查自己仍然是给定 term 的 Candidate

由于我们 replication 和 election 实现的对称性，可以发现前两个和后两个是对称的，因此很好记忆。
123456789101112131415161718192021222324252627282930313233343536373839404142434445464748replicateToPeer := func(peer int, args *AppendEntr ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/7177791d.html" title="16. Raft PartC 调试和小结"><img class="post-bg" src="https://picsum.photos/1276/400?random=116" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="16. Raft PartC 调试和小结"></a></div><div class="recent-post-info"><a class="article-title" href="/7177791d.html" title="16. Raft PartC 调试和小结">16. Raft PartC 调试和小结</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">工欲善其事，必先利其器。这次在调试之前，我们首先再加一些之前没有加到位的调试日志。有了这些关键环节的日志，我们就可以追踪日志试探匹配过程中冲突以及后撤的 index 变迁轨迹和当时 Leader、Follower 两方日志构成。有了这些，即使我们一开始实现出错，也可以根据这些信息来修正我们的优化算法。
加些日志
由于大部分时候我们并不需要特别详细的信息，因此我们将这些日志信息大多都加为 Debug 级别，可以通过设置 VERBOSE = 0 来打印，VERBOSE = 1  来关闭对 Debug 日志的打印。
RPC 收发信息
每个 RPC 发送出去、收到的时候，都可以打印下关键参数信息。为了复用，我们可以给 RPC 用到的 XXXArgs 各自构造一个 format 好的 String() 函数。且尽量的简洁的打印信息。
领导选举模块收发信息：
1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253func (args *RequestVoteA ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/c7b2b173.html" title="17. Raft PartD 日志压缩"><img class="post-bg" src="https://picsum.photos/1276/400?random=117" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="17. Raft PartD 日志压缩"></a></div><div class="recent-post-info"><a class="article-title" href="/c7b2b173.html" title="17. Raft PartD 日志压缩">17. Raft PartD 日志压缩</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">实现要求
对于一个长时间运行的 Raft 系统，如果持续收到日志，会遇到以下问题：

空间不够：如果日志无限追加下去，本地硬盘空间可能存不下。
重启过慢：因为重启时需要重放（ replay）所有日志，如果日志过长，重放过程将会持续很久不能正常对外提供服务。

一个经典的解决办法是，定期对日志做快照（snapshot）。针对某个日志 entry 做了快照之后，该 entry 以及以前的日志变都可以被截断（truncate）。当然，这种方法能解决的我们上面两个问题的本质原因在于：相比日志，快照的存储更为紧凑。日志记录的是事件（比如 update k1 = v2），而快照通常记录的是数据条目（比如 &#123;k1: v1, k2: v2&#125;），而一个数据条目通常会在事件中出现多次（写入-更新-删除等等），因此从日志到快照通常会有压缩空间。
但这样同时会引出另一个问题：如果 Leader 想给从节点发送日志时，发现相关日志条目已经被截断怎么办？这就需要引入一个新的 RPC：InstallSnapshot。通过此 RPC，先将 Leader 的 Snapshot 无脑同步给 Follo ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/c3c187c5.html" title="19. Raft PartD 快照数据流"><img class="post-bg" src="https://picsum.photos/1276/400?random=119" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="19. Raft PartD 快照数据流"></a></div><div class="recent-post-info"><a class="article-title" href="/c3c187c5.html" title="19. Raft PartD 快照数据流">19. Raft PartD 快照数据流</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">本节我们要实现 InstallSnapshot 相关 RPC 。为了避免丢三落四，我们遵循一条 snapshot 数据流主线，来分四个步骤，一步步实现：

Leader 的应用层调用 raft.Snapshot(index, snapshot) 函数

保存 snapshot
截断日志
持久化


Leader 在需要时使用该 snapshot 构造参数发送 RPC 给 Follower
Follower 接收到 Leader RPC 后替换本地日志，并将其持久化
Follower 通过 ApplyMsg 将 snapshot 传给 Follower 应用层


和之前一样，为了保持模块的内聚性，我们新建一个文件raft_compaction.go 将 Snapshot() 接口和 InstallSnapshot 相关 RPC 都放在一块。
调用 Snapshot() 接口
Leader 的应用层调用 Snapshot(index, snapshot) 接口后，我们会在 index 处截断现有日志，将 snapshot 保存在 rf.log 中，同时将其持久化，以应对可能得宕机重启。
 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/f64e6a5d.html" title="18. Raft PartD 日志重构"><img class="post-bg" src="https://picsum.photos/1276/400?random=118" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="18. Raft PartD 日志重构"></a></div><div class="recent-post-info"><a class="article-title" href="/f64e6a5d.html" title="18. Raft PartD 日志重构">18. Raft PartD 日志重构</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">要支持 Compaction，需要对日志进行诸多改造。干脆，我们将相关逻辑封装到一个 struct 中。
于是我们新创建一个 RaftLog 的结构体，以支持：

在 index 处进行 Snapshot：将 index 以及之前的日志阶段掉
基本读写操作：

读取：在 Snapshot 存在时，需要做下标转换，但在没有 Snapshot 时又不用，需要想办法进行统一。
追加：包括在末尾追加（用于应用层给 Leader 追加日志）、在给定下标处覆盖追加（用于 Leader 覆写 Follower 日志）等等。



当然，以上需求是在有一个基本想法之后，再去看其他所有使用到 RaftLog 的代码，然后总结出来的。但为了行文方便，我直接放在了开始，所以乍一看会有些突兀。
RaftLog 实现
结构体字段
我们新建一个文件，起名为 raft_log.go ，然后定义一个 RaftLog 的结构体。主要包含三部分：

前面日志截断后 compact 成的 snapshot
后面的剩余日志 tailLog
两者的分界线，也就是上一节要求中提到的：lastIncludeTerm/lastInc ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/5980c7c3.html" title="23 kvraft Client 端处理"><img class="post-bg" src="https://picsum.photos/1276/400?random=123" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="23 kvraft Client 端处理"></a></div><div class="recent-post-info"><a class="article-title" href="/5980c7c3.html" title="23 kvraft Client 端处理">23 kvraft Client 端处理</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">前面一节主要了解了我们基于 raft 实现的分布式 KV 的大致架构和代码框架，从这一节开始就需要开始具体的代码逻辑了，我们首先需要实现的是客户端的逻辑。
上一节中提到了客户端的结构体 Clerk：
1234type Clerk struct &#123;   servers []*labrpc.ClientEnd   // You will have to modify this struct.&#125;
可以看到其中维护了 servers 列表，表示的是后端分布式 KV 服务的所有节点信息，我们可以通过这个信息去向指定的节点发送数据读写的请求。
前面提到了三种类型的请求，主要是：

Get
Put
Append

每个 kv 服务的节点都是一个 raft 的 peer，客户端发送请求到 kv 服务的 Leader 节点，然后 Leader 节点会存储请求日志在本地，然后将日志通过 raft 发送给其他的节点进行状态同步。所以 raft 日志其实存储的是一连串客户端请求，然后 server 节点会按照顺序执行请求，并将结果存储到状态机中。
这里 Clerk 发送请求的时候，由于事先 ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/#content-inner">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/#content-inner">5</a><a class="extend next" rel="next" href="/page/3/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=47381770&amp;s=140" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Bugtrap</div><div class="author-info__description">欢迎访问我的博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" href="https://lihaonet.github.io/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://lihaonet.github.io" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:47381770@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="http://bugtrap.ysepan.com" target="_blank" title="永硕E盘"><i class="fa-sharp fa-solid fa-hard-drive" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/./img/wx.jpg" target="_blank" title="微信"><i class="fa-brands fa-weixin" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">正常更新中...</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/e89635fc.html" title="01. Raft 论文解读"><img src="https://picsum.photos/1276/400?random=101" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="01. Raft 论文解读"/></a><div class="content"><a class="title" href="/e89635fc.html" title="01. Raft 论文解读">01. Raft 论文解读</a><time datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/da698a95.html" title="02. Raft 代码总览"><img src="https://picsum.photos/1276/400?random=102" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="02. Raft 代码总览"/></a><div class="content"><a class="title" href="/da698a95.html" title="02. Raft 代码总览">02. Raft 代码总览</a><time datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/66d80af5.html" title="03. Raft PartA 领导者选举"><img src="https://picsum.photos/1276/400?random=103" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="03. Raft PartA 领导者选举"/></a><div class="content"><a class="title" href="/66d80af5.html" title="03. Raft PartA 领导者选举">03. Raft PartA 领导者选举</a><time datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/bb4df00d.html" title="04. Raft PartA 状态转换"><img src="https://picsum.photos/1276/400?random=104" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="04. Raft PartA 状态转换"/></a><div class="content"><a class="title" href="/bb4df00d.html" title="04. Raft PartA 状态转换">04. Raft PartA 状态转换</a><time datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/f6c558d8.html" title="05. Raft PartA 选举逻辑"><img src="https://picsum.photos/1276/400?random=105" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="05. Raft PartA 选举逻辑"/></a><div class="content"><a class="title" href="/f6c558d8.html" title="05. Raft PartA 选举逻辑">05. Raft PartA 选举逻辑</a><time datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2024 By Bugtrap</div><div class="footer_custom_text">欢迎访问<a href="https://lihaonet.github.io/">我的博客</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>window.typedJSFn = {
  init: (str) => {
    window.typed = new Typed('#subtitle', Object.assign({
      strings: str,
      startDelay: 300,
      typeSpeed: 150,
      loop: true,
      backSpeed: 50,
    }, null))
  },
  run: (subtitleType) => {
    if (true) {
      if (typeof Typed === 'function') {
        subtitleType()
      } else {
        getScript('https://cdn.jsdelivr.net/npm/typed.js/dist/typed.umd.min.js').then(subtitleType)
      }
    } else {
      subtitleType()
    }
  }
}
</script><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["我也会有恐惧和贪婪，只不过是在大众贪婪时恐惧，在大众恐惧时贪婪！@巴菲特","每个人出生的时候都是原创，可悲的是很多人渐渐都成了盗版","一个人的价值, 在于他贡献了什么, 而不在于他获得了什么!\t@爱因斯坦","你若喜爱你自己的价值, 你就得给世界创造价值!\t@歌德","未经反思自省的人生不值得去过The unexamined life is not worth living.@苏格拉底(哲学之父)","活着, 如同生命最后一天般活着;\t学习, 如同永远活着般学习!\t@圣雄甘地 (印度国父)"]
        sub.unshift(data.hitokoto, from)
        typedJSFn.init(sub)
      } else {
        document.getElementById('subtitle').textContent = data.hitokoto
      }
    })
}
typedJSFn.run(subtitleType)
</script></div><><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;/e89635fc.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://picsum.photos/1276/400?random=101" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-01-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;/e89635fc.html&quot;);" href="javascript:void(0);" alt="">01. Raft 论文解读</a><div class="blog-slider__text">从零实现分布式 KV</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;/e89635fc.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;/d3d73bbd.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://picsum.photos/1276/400?random=7" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-01-25</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;/d3d73bbd.html&quot;);" href="javascript:void(0);" alt="">好软分享</a><div class="blog-slider__text">好软分享</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;/d3d73bbd.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;/b595ee6b.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://picsum.photos/1276/400?random=6" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-01-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;/b595ee6b.html&quot;);" href="javascript:void(0);" alt="">省考资料</a><div class="blog-slider__text">24省考资料</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;/b595ee6b.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;/bca05d86.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://picsum.photos/1276/400?random=3" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-01-03</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;/bca05d86.html&quot;);" href="javascript:void(0);" alt="">每日一言</a><div class="blog-slider__text">每日一言，学习新思想，争做新青年！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;/bca05d86.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;/61933d8.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://picsum.photos/1276/400?random=2" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-01-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;/61933d8.html&quot;);" href="javascript:void(0);" alt="">记事簿</a><div class="blog-slider__text">统计代码，名录划分，excel技巧</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;/61933d8.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><!-- hexo injector body_end end --></body></html>