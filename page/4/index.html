<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Bugtrap - 简单、自由、随性！</title><meta name="author" content="Bugtrap"><meta name="copyright" content="Bugtrap"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="欢迎访问我的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Bugtrap">
<meta property="og:url" content="https://lihaonet.github.io/page/4/index.html">
<meta property="og:site_name" content="Bugtrap">
<meta property="og:description" content="欢迎访问我的博客">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://q1.qlogo.cn/g?b=qq&nk=47381770&s=140">
<meta property="article:author" content="Bugtrap">
<meta property="article:tag" content="blog,hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://q1.qlogo.cn/g?b=qq&nk=47381770&s=140"><link rel="shortcut icon" href="https://q1.qlogo.cn/g?b=qq&nk=47381770&s=100"><link rel="canonical" href="https://lihaonet.github.io/page/4/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Bugtrap',
  isPost: false,
  isHome: true,
  isHighlightShrink: true,
  isToc: false,
  postUpdate: '2024-01-31 11:59:51'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/style.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.0.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=47381770&amp;s=140" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 常用</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page fixed" id="page-header" style="background: transparent"><nav id="nav"><span id="blog-info"><a href="/" title="Bugtrap"><span class="site-name">Bugtrap</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 常用</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Bugtrap</h1><div id="site-subtitle"><span id="subtitle"></span></div><div id="site_social_icons"><a class="social-icon" href="https://lihaonet.github.io" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:47381770@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="http://bugtrap.ysepan.com" target="_blank" title="永硕E盘"><i class="fa-sharp fa-solid fa-hard-drive" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/./img/wx.jpg" target="_blank" title="微信"><i class="fa-brands fa-weixin" style="color: #4a7dbe;"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left"><a href="/cf40ca3f.html" title="32 shardkv 配置变更"><img class="post-bg" src="https://picsum.photos/1276/400?random=132" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="32 shardkv 配置变更"></a></div><div class="recent-post-info"><a class="article-title" href="/cf40ca3f.html" title="32 shardkv 配置变更">32 shardkv 配置变更</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">前面一节我们处理了单个 Group 的逻辑，其实比较简单，和我们前面在 Lab3 实现的分布式 KV 是基本类似的。
今天这一节来处理下配置变更的问题。
shardkv 需要定时从 shardctrler 这边拉取最新的配置，然后根据配置来确定哪些 shard 应该是需要进行迁移的。
上一节我们已经写了一个简单的拉取配置的后台任务，但是按照 lab 的提示，我们每次只能够拉取一个配置，并且按照顺序处理，这样做的目的主要是为了避免覆盖还未完成的配置变更任务。
123456789101112// 获取当前配置func (kv *ShardKV) fetchConfigTask() &#123;   for !kv.killed() &#123;      kv.mu.Lock()      newConfig := kv.mck.Query(kv.currentConfig.Num + 1)      kv.mu.Unlock()      // 传入 raft 模块进行同步      kv.ConfigCommand(RaftCommand&#123;ConfigChange, newC ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/656a341b.html" title="31 shardkv 单 Group 逻辑"><img class="post-bg" src="https://picsum.photos/1276/400?random=131" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="31 shardkv 单 Group 逻辑"></a></div><div class="recent-post-info"><a class="article-title" href="/656a341b.html" title="31 shardkv 单 Group 逻辑">31 shardkv 单 Group 逻辑</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:54:04.000Z" title="更新于 2024-01-29 09:54:04">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">前面几节我们主要实现了分片分布式 KV 中的第一个重要的组成部分，那就是 shard controller，并且实现了获取和更改配置的接口。
接下来我们就需要回归到 shardkv 的具体逻辑了，这里贴一下我们的整体架构图，简单回顾一下：

我们的 shardkv 是由多个 Replica Group 组成的，每个 Replica Group 又是由一个 raft 集群组成，使用 raft 共识算法保证数据的一致性。每个 Group 都负责了一部分 shard 的读写请求，全部的 Group 组合到一起，就是一个完整的 shardkv 服务。
Shardctrler 负责存储配置信息，主要是 shard 到 Group 的分配关系，当配置发生变化的时候，Group 应该根据配置处理 shard，并且这里需要保证在处理配置变更时，客户端不能看到不一致的结果。
客户端会通过 Get、Put、Append 这三个方法来访问 shardkv，需要保证 Put 成功之后的结果对于后续的请求是可见的，即使 Put 请求和配置变更同时发生。
首先我们可以处理一种最简单的情况，即集群中只有一个 Gro ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/cd6a3100.html" title="34 shardkv 分片清理"><img class="post-bg" src="https://picsum.photos/1276/400?random=134" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="34 shardkv 分片清理"></a></div><div class="recent-post-info"><a class="article-title" href="/cd6a3100.html" title="34 shardkv 分片清理">34 shardkv 分片清理</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">前面一节我们主要处理了 shardkv 分片迁移的主要流程，配置变更时更改 shard 的状态，并且启动一个后台线程，定期获取 shard 的状态，执行实际的 shard 迁移。
Shard 有四种状态：

Normal
MoveIn
MoveOut
GC

在前面的实现中，如果一个 shard 已经从 Group 迁移出去了，这个 shard 还会在这个 Group 中存在，并且数据也会继续保留。
但实际上，因为 shard 已经完全迁移到了另一个 Group 中，所以这个 shard 在原 Group 中已经可以不用继续保留了，我们可以将其删除掉。
在 lab4 的 challenge 1 中，要求我们及时清理 Group 中已经无效的 shard，这样能够及时释放空间。
在上一节 shard 迁移的流程中，如果一个 shard 已经完成了迁移，我们会将其置为 GC 状态，所以我们可以启动一个后台线程，定时获取需要执行 GC 的 shard。
拿到这些 shard 之后，我们需要做两件事情，一是给旧的 Group 发送消息，删除对应的 shard；二是给当前 Group 的 sha ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/6794c952.html" title="33 shardkv 分片迁移"><img class="post-bg" src="https://picsum.photos/1276/400?random=133" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="33 shardkv 分片迁移"></a></div><div class="recent-post-info"><a class="article-title" href="/6794c952.html" title="33 shardkv 分片迁移">33 shardkv 分片迁移</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">前面一节我们处理了配置变更的需求，主要是定时从 shardctrler 中拉取配置，我们对传入 raft 模块的结构体进行了一些改造，使其能够兼容两种不同类型的请求，分别是用户操作和配置变更。
用户操作和之前的一样，并没有任何的变化，只是反解析结构体的时候需要注意。
配置变更的操作，上一节主要是简单处理了一下，主要的 shard 迁移流程需要我们继续完善。
在商讨 shard 迁移的具体流程之前，我们可以来简单看一下官方 lab4 给出的一些提示：

在 KVServer 中添加定期从 shardctrler 拉取配置的代码，并且如果客户端请求的 shard 不属于当前 Group，那么应该返回 ErrWrongGroup 错误。这个加上之后，应该仍然能通过第一个测试。
确保 KVServer 中的 Get、Put、Append 方法和配置变更同时发生时，需要有一致的行为。
一次处理一个配置变更的请求，并且按照顺序。
需要在 shard 迁移期间，确保对重复请求的过滤，保证线性一致性。
在一个 shard 迁移到新的 Group 之后，原来的 Group 可以继续持有并不属于它的旧的  ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/a883a665.html" title="35 shardkv 补充修改"><img class="post-bg" src="https://picsum.photos/1276/400?random=135" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="35 shardkv 补充修改"></a></div><div class="recent-post-info"><a class="article-title" href="/a883a665.html" title="35 shardkv 补充修改">35 shardkv 补充修改</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">在 shardkv 的分片迁移和清理大致完成之后，我们还需要修改几个地方，才能够将测试 run 起来。
主要有以下改动：

matchGroup 方法，需要判断 shard 的状态，如果是 GC 或者 Normal 状态，均可以继续提供服务
StartServer 方法中，需要注册 labgob 相关的结构体。
makeSnapshot 和 restoreFromSnapshot 中， config 信息也需要进行持久化，并且需要初始化 shard 的状态
fetchConfigTask 中，需要加上一个判断，如果任何一个 shard 的状态是非 Normal 的，则说明前一个 shard 迁移的流程还在进行中，我们就跳过拉取新的配置，避免覆盖之前的任务
Apply 的时候，客户端操作也需要判断 Group 是否匹配

</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/f97d814d.html" title="36 附录1. 并发编程"><img class="post-bg" src="https://picsum.photos/1276/400?random=136" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="36 附录1. 并发编程"></a></div><div class="recent-post-info"><a class="article-title" href="/f97d814d.html" title="36 附录1. 并发编程">36 附录1. 并发编程</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">Raft 通常是是一个多机、多线程的库（lib），因此会涉及大量并发编程知识。 由于在语言层面内置 goroutine 和 channel，Golang 大大简化了并发编程复杂度，这也是课程选择 golang 为编程语言的主要原因。
Goroutine
goroutine 是一种轻量级线程，是 go runtime 提供的一种用户态线程，因此也被称为协程。所谓轻量，就是相比操作系统线程，每个 goroutine 耗费的资源更少、goroutine 间切换耗费也更低（不会陷入内核态），因此可以有更高的并发度。因此，我们在 golang 中，可以相对随意的创建新的 goroutine。
但我们在决定是否使用 goroutine 时，仍然有一些原则和技巧可以遵循。原则上来说，使用 goroutine 的目的主要有两种：

提升计算性能：主要针对计算密集型任务，多开 goroutine，充分利用现代计算机多核性能。
旁路 IO 负载：主要针对有 IO 型任务的负载，比如 RPC 和文件 IO，将其放到单独 goroutine 中，避免影响主干工作流性能。

对于 raft 来说，主要后面一种情 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/23d7aeb6.html" title="37 附录2. 分布式调试"><img class="post-bg" src="https://picsum.photos/1276/400?random=137" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="37 附录2. 分布式调试"></a></div><div class="recent-post-info"><a class="article-title" href="/23d7aeb6.html" title="37 附录2. 分布式调试">37 附录2. 分布式调试</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T01:46:56.000Z" title="更新于 2024-01-29 09:46:56">2024-01-29</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FKV/">分布式KV</a></span></div><div class="content">在分布式系统中进行调试本就是一个难点，而本实验无疑让这一点更加困难：

多机日志混杂。用单机模拟的分布式系统，将所有节点的日志汇聚到了一块，无疑加大了根据日志进行问题定位的难度。
网络环境复杂。为了在较短时间测出各种边角情况，本实验的测试通过（使用 labrpc 进行 mock）接管 RPC 层，将真实环境中频次很低的网络故障（RPC 消息乱序到达或者干脆丢失）大大提高。这让日志中的时间线非常难以追踪，进而定位各种事情发生的因果关系。

实验所需的 Raft 的代码并不算太多，最终大家花在调试（Debug）的时间要远比编码的时间要多，当然在真实工作中也是如此。因此，一个科学的调试方法就显的非常重要，他能大大加快你定位问题的速度。甚而，一个好的调试方法能让枯燥的调试过程变成充满趣味性的通关过程。
下面主要参考 Debugging by Pretty Printing 一文和我的一些经验，来介绍一种针对本实验多节点日志混杂、RPC 通信多变的情况的调试技术。
基本原理
对于编程调试，我们最常用的方法有两种：借助工具单步执行和手动埋点分析。但无论是多线程还是分布式编程，使用（类似的 gdb） ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/d3d73bbd.html" title="好软分享"><img class="post-bg" src="https://picsum.photos/1276/400?random=7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="好软分享"></a></div><div class="recent-post-info"><a class="article-title" href="/d3d73bbd.html" title="好软分享">好软分享</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-25T02:00:00.000Z" title="发表于 2024-01-25 10:00:00">2024-01-25</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-26T01:57:24.000Z" title="更新于 2024-01-26 09:57:24">2024-01-26</time></span></div><div class="content">
    
        
            Umi-OCR
        
         : Umi-OCR 是一款在GitHub开源免费的文字识别工具，它能够将图像中的文字提取出来，并将其转化为可编辑的文本。 这项技术基于深度学习和计算机视觉算法，具备出色的准确性和高效的处理能力。
    
    
        
            PDFgear
        
          : PDFgear集聊天、编辑、压缩、阅读、转换、注释、签名、整理、打印、表单、OCR识别于一体，几乎涵盖了所有PDF相关的操作。
    
    buyixiao.github.io
    
#在线工具 #抠图 #PS #换背景
图片：
无需登录：
    BgSub https://bgsub.cn/
    在线抠图 换底 https://www.remove.bg/zh
    起兮深探-AI智能在线抠图 http://matting.deeplor.com/#/
    
需登录：
    FocoClipping https://www.fococlippin ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/b595ee6b.html" title="省考资料"><img class="post-bg" src="https://picsum.photos/1276/400?random=6" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="省考资料"></a></div><div class="recent-post-info"><a class="article-title" href="/b595ee6b.html" title="省考资料">省考资料</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-15T02:10:50.000Z" title="发表于 2024-01-15 10:10:50">2024-01-15</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-28T14:48:06.000Z" title="更新于 2024-01-28 22:48:06">2024-01-28</time></span></div><div class="content">言语1全屏查看

判断2全屏查看
资料3全屏查看
申论4全屏查看
</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/61933d8.html" title="记事簿"><img class="post-bg" src="https://picsum.photos/1276/400?random=2" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记事簿"></a></div><div class="recent-post-info"><a class="article-title" href="/61933d8.html" title="记事簿">记事簿</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-10T02:10:50.000Z" title="发表于 2024-01-10 10:10:50">2024-01-10</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-29T08:35:12.000Z" title="更新于 2024-01-29 16:35:12">2024-01-29</time></span></div><div class="content">村代码12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061140882001001140882001002140882001003140882001004140882001005140882001006140882001007140882001008140882001010140882001200140882001201140882001202140882001204140882001205140882001206140882001207140882001208140882001210140882001211140882001214140882001219140882002004140882002016140882002017140882002020140882002200140882002204140882002205140882002207140882002212140882002213140882003200 ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/3/#content-inner"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/#content-inner">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/#content-inner">5</a><a class="extend next" rel="next" href="/page/5/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=47381770&amp;s=140" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Bugtrap</div><div class="author-info__description">欢迎访问我的博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" href="https://lihaonet.github.io/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://lihaonet.github.io" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:47381770@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="http://bugtrap.ysepan.com" target="_blank" title="永硕E盘"><i class="fa-sharp fa-solid fa-hard-drive" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/./img/wx.jpg" target="_blank" title="微信"><i class="fa-brands fa-weixin" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">正常更新中...</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/e89635fc.html" title="01. Raft 论文解读"><img src="https://picsum.photos/1276/400?random=101" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="01. Raft 论文解读"/></a><div class="content"><a class="title" href="/e89635fc.html" title="01. Raft 论文解读">01. Raft 论文解读</a><time datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/bb4df00d.html" title="04. Raft PartA 状态转换"><img src="https://picsum.photos/1276/400?random=104" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="04. Raft PartA 状态转换"/></a><div class="content"><a class="title" href="/bb4df00d.html" title="04. Raft PartA 状态转换">04. Raft PartA 状态转换</a><time datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/da698a95.html" title="02. Raft 代码总览"><img src="https://picsum.photos/1276/400?random=102" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="02. Raft 代码总览"/></a><div class="content"><a class="title" href="/da698a95.html" title="02. Raft 代码总览">02. Raft 代码总览</a><time datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/66d80af5.html" title="03. Raft PartA 领导者选举"><img src="https://picsum.photos/1276/400?random=103" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="03. Raft PartA 领导者选举"/></a><div class="content"><a class="title" href="/66d80af5.html" title="03. Raft PartA 领导者选举">03. Raft PartA 领导者选举</a><time datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/f6c558d8.html" title="05. Raft PartA 选举逻辑"><img src="https://picsum.photos/1276/400?random=105" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="05. Raft PartA 选举逻辑"/></a><div class="content"><a class="title" href="/f6c558d8.html" title="05. Raft PartA 选举逻辑">05. Raft PartA 选举逻辑</a><time datetime="2024-01-27T16:00:00.000Z" title="发表于 2024-01-28 00:00:00">2024-01-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2024 By Bugtrap</div><div class="footer_custom_text">欢迎访问<a href="https://lihaonet.github.io/">我的博客</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>window.typedJSFn = {
  init: (str) => {
    window.typed = new Typed('#subtitle', Object.assign({
      strings: str,
      startDelay: 300,
      typeSpeed: 150,
      loop: true,
      backSpeed: 50,
    }, null))
  },
  run: (subtitleType) => {
    if (true) {
      if (typeof Typed === 'function') {
        subtitleType()
      } else {
        getScript('https://cdn.jsdelivr.net/npm/typed.js/dist/typed.umd.min.js').then(subtitleType)
      }
    } else {
      subtitleType()
    }
  }
}
</script><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["我也会有恐惧和贪婪，只不过是在大众贪婪时恐惧，在大众恐惧时贪婪！@巴菲特","每个人出生的时候都是原创，可悲的是很多人渐渐都成了盗版","一个人的价值, 在于他贡献了什么, 而不在于他获得了什么!\t@爱因斯坦","你若喜爱你自己的价值, 你就得给世界创造价值!\t@歌德","未经反思自省的人生不值得去过The unexamined life is not worth living.@苏格拉底(哲学之父)","活着, 如同生命最后一天般活着;\t学习, 如同永远活着般学习!\t@圣雄甘地 (印度国父)"]
        sub.unshift(data.hitokoto, from)
        typedJSFn.init(sub)
      } else {
        document.getElementById('subtitle').textContent = data.hitokoto
      }
    })
}
typedJSFn.run(subtitleType)
</script></div><><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;/e89635fc.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://picsum.photos/1276/400?random=101" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-01-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;/e89635fc.html&quot;);" href="javascript:void(0);" alt="">01. Raft 论文解读</a><div class="blog-slider__text">从零实现分布式 KV</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;/e89635fc.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;/d3d73bbd.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://picsum.photos/1276/400?random=7" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-01-25</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;/d3d73bbd.html&quot;);" href="javascript:void(0);" alt="">好软分享</a><div class="blog-slider__text">好软分享</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;/d3d73bbd.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;/b595ee6b.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://picsum.photos/1276/400?random=6" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-01-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;/b595ee6b.html&quot;);" href="javascript:void(0);" alt="">省考资料</a><div class="blog-slider__text">24省考资料</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;/b595ee6b.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;/bca05d86.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://picsum.photos/1276/400?random=3" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-01-03</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;/bca05d86.html&quot;);" href="javascript:void(0);" alt="">每日一言</a><div class="blog-slider__text">每日一言，学习新思想，争做新青年！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;/bca05d86.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;/61933d8.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://picsum.photos/1276/400?random=2" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-01-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;/61933d8.html&quot;);" href="javascript:void(0);" alt="">记事簿</a><div class="blog-slider__text">统计代码，名录划分，excel技巧</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;/61933d8.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><!-- hexo injector body_end end --></body></html>